/*
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mMMMMMMMMMNNNmmNNNMMNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNMMNMMMMNNNNNmmmddhdddNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mddNMMNy:/odNmmddmmNNmdhhddmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmmdNMNd:--+dNmmddhhddmmhsyhhmdmmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNmdNmy:.-oyNmmmhmdhho+sososyhhhddNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmmNdh+-`.:oyNNdmmdmmdo-://oysssyhhhdmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
Nmmmoyyyo+osdNmdmmddNNhs+/::/+osyssydyhdNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NNmhsymMMNmmmmdmdNNddNmsso+++////ossssyyhdmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mhhhmNNMNNNhssshhmmddmmssyooooso/::+oysshhhhmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmdhdddNNdyoosyhdmddmmmsoooooyysyys/::/oyyhhhyMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mdddhddmhsooshdmdmdhhyyyysso/ooo+syhhs/-/+shyhMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
dyyhdmd+ososhdmdmyyhhhhhhhyo++o/+///+ohhso++sdMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
dhdmNNdsossyhmdmsydhssssyhhs/++o/o+//:++yhhy+/hNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mdmNNNNmhysshddyshdyyy/oss+s::/:://++///++++/::hmNNNNNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NNMNNNmmNNdymNNhshdshdyhdysh+sy+-:++osssosss++yNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNNNmdNNmNmmmNmyyddyyhdhydyohys/-oo+osssysyyohNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNNNhdNmmNNmNMMNhyyhhhdhyyhmmyh+-/s+sysssyyhyydNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mNMMMhdNdmMNMMMMMNNmdhdddmhdmmNho/-osoyyo++oyddhhNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NMMMNmhNdNMNMNMMNmNNNmmmdyoohmhoyo::hsooo++oooydhymMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMNNNhmNNMmmNMNNmmmmdmmdyhhoyddddoo++yoyysooossyhsmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMNNNmmNNNmdNdNmmddhhhdNNhsmNssdooo/dso++osyyysoymMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMNNNNmNNNNNmddmmNhshNmmmNmNMdhNsh/ohho++/:++MMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MNNNMMNNNNmmmhhhhdyosdNmdmMMhoNmhdmys+ooo++/+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNNNMMNNNNmddmdoodmMMNmmNNhssdmNMMMNdNd/osomMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNdhMNmNNMNmdNddohmMMNNNmdmdddNMMMMMMMMmMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNhmMmmmmNNmdNyoNMNmNmdhyyyhdhoyNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmdmMmmddddNmmdys+hmMMMmmhysssyy++dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmdNMMdmdddmmNNyshmNNNNNNNdhhs+yy//dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNMMMdmdddmmMNysdmNNMMMNhhNdhs+y+/:mMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNMMNhmmddNNNMdyydmMMMNdyshNhyoss+:/MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNMMddmmmmNMNMNdsymNNmdhhdNMNdhsss+:yMMMMMMMMMMMMMMMMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMdhmmmmmNMNNMmshNMMMmmMMMMMmNdyo+//NMMMMMMMMMMMMMMMhNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMmhmmmmmmNMMNNMyshdhhhyhNMMMMMMdhso+sMMMMMMMMMMMMMMMhmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMmdmmmmmmmNMMMmNm+ys++oyyNMMMMMMNmmyyoyNMMMMMMMMMMMMMddMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmmmmmmmmmmmNMNNmNNyyo+/oohNMMMMMMMMdhhsshmMMMMMMMMMMMyNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNNNNNNmmmmNMMNmmddNmmdhhdmMMMMMMMMMNddhssshmmNNNmmdhdMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NNNNNNNNNNNNNNNNmNNNNMMMMMNomMMMMMMMMMNNmdhhyyyyyyyhdmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
Nd+oNMMMMMMMmodo++++++++++m..yNMMMMMNo+mNMMmhssshdNMMNhNMMMMMMMMMMMddMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MN+ /NMMMMMm: d` -ssssss+`d. `+mMMMMN. dNm+:+syso//hNN--yNMMMMMMMd+`yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMN+ /NMMMm: oM` +NMMMMMNdN. /`.yNMMN. dh.omMMMMMNy.oM- `:hNMMMm+.  yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMN/ /NMm: oNy` :sssmMMMMN. dh-`/mMN. d-/NMMMMMMMMy`m- y/`/dmo..o: yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMN/ /m: +NNy. /yyyNMMMMN. dNNo`.yN- d.oNMMMMMMMMd d- mNh-`.`+mN/ yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMN/ . +NMMN- oNMMMMMNdN. dMMMd:`/. ds.dNMMMMMMm::M- dMMNy/dMMN/ yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMN/ +NMMMN- /yyyyyys d. dMMMMNo`  dNy-+ymmmho-+NN- dMMMMMMMMN/ yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMNyNMMMMN+::::::::::m+/mMMMMMMd: dMMNho///+ymMMN+/mMMMMMMMMNs/hMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMNMMMMMMMMMMMMMMMMMMMMMMMMMMMMNsmMMMMMMMMMMMMMMNNNNMMNNNMMNNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNMMMMMMMMMMMMMMNMMNMNMMMNMMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNMMNMNMMMNMMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNNNNMMNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
all copyright reservation for S2 Click, Inc
*/
import { readFileSync, existsSync, writeFileSync, mkdir } from 'fs';
import latestVersion from 'latest-version';
import { Page } from 'puppeteer';
import { from, interval, timer } from 'rxjs';
import { map, takeUntil, tap, delay, switchMap } from 'rxjs/operators';
import { Whatsapp } from '../api/whatsapp';
import { CreateConfig, defaultOptions } from '../config/create-config';
import { upToDate } from '../utils/semver';
import { isAuthenticated, isInsideChat, needsToScan, retrieveQR } from './auth';
import { initWhatsapp, injectApi } from './browser';
import chalk = require('chalk');
import boxen = require('boxen');
import Spinnies = require('spinnies');
import path = require('path');
import {
  tokenSession,
  defaultTokenSession,
} from '../config/tokenSession.config';
const { version } = require('../../package.json');

// Global
let updatesChecked = false;

/**
 * consult status of whatsapp client
 */

/**
 * Should be called to initialize whatsapp client
 */
export async function create(
  session = 'session',
  catchQR?: (qrCode: string, asciiQR: string) => void,
  statusFind?: (statusGet: string) => void,
  options?: CreateConfig
) {
  const spinnies = new Spinnies({
    disableSpins: options ? options.disableSpins : '',
  });

  console.log(`\n
â–—â–„ â–„ â–„  â–„â–„â–„ â–„   â–„â–„â–„  â–—â–„â–„â––â–—â–„â–– â–—â–„â––â–„â–„â–„â––                           
 â–ˆâ–Ÿâ–ˆâ–™â–ˆ  â–ˆâ–„â–„ â–ˆ   â–ˆ    â–ˆ â–â–ˆ â–ˆ â–ˆ â–ˆ â–ˆâ–„â–„                           
 â–â–ˆ â–ˆâ–Œ  â–ˆâ–„â–„ â–ˆâ–ˆâ–ˆ â–œâ–„â–›â–˜ â–œâ–™â–Ÿâ–€ â–ˆ   â–ˆ â–ˆâ–„â–„â––                           
                                                      
â–„â–„â–„â––       â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–Ÿâ–Œâ–€â––     â–—â–„â–„â––                        
â–â–„ â–â––     â–Ÿâ–˜â–         â–â–Œ â–â–™    â–  â–Œ â–„â–â–€â–€â–€â–€â–€â–„â–– â–›â–€â–„        â–„â–˜â–Œ
 â–â–„ â–â––   â–â–˜ â–Ÿâ–– â–œâ–€â–€â–€â–€â–€â–Œâ–â––  â–â–šâ––  â–  â–™â–â–˜â–—â–â–€â–€â–€â–šâ––â–â–™â–› â–â–œâ––    â–—â–€  â–Œ
  â–€â–– â–œ  â–—â–˜ â–Ÿâ–ˆ  â–œ     â–â–â–Œ â–Ÿâ–– â–œâ–– â–  â–ˆ â–Ÿâ–˜     â–â––â–â–ˆ   â–â–™â––â–—â–â–˜   â–Œ
   â–œâ–– â–œâ–„â–› â–â–œâ–  â– â–˜â–œ   â–â–Œ â–Ÿâ–€â–– â–â–™â–  â–Œâ–—â–Œ       â–œ â–™ â–â–™â–– â–€â–˜ â–—â–Ÿâ–˜ â–Œ
    â–šâ–– â–€ â–—â–Œâ–â–œâ–– â–œâ–€â–€â–€   â–â–Œ â–Ÿ â–â–™  â–œ  â–™ â–™       â–› â–™ â–â–Œâ–â–„  â–Ÿâ–€â–â–˜ â–Œ
     â–šâ–– â–—â–›  â–â–– â–œ    â–—â–›â–œâ–Œ â–Ÿ   â–šâ––   â–ˆâ––â–â–™â––   â–—â–› â–Ÿâ–› â–â––  â–€â–  â–â–– â–Œ
     â–â–šâ–—â–›   â–   â–˜â–˜â–˜â–˜â–˜ â–â–Œ â–Ÿ    â–€â–„  â–Œâ–â–™â––â–â–€â–€â–€â–˜â–—â–â–˜â–› â–â–Œ      â–  â–Œ
      â–â–›    â–â–€â–â–˜â–˜â–˜â–˜â–˜â–˜â–€â–â–˜â–˜â–€     â–â–™ â–Œ  â–â–€â–˜â–˜â–€â–€â–˜  â–€â–˜â–€       â–â–€â–â–˜
                                 â–šâ–Œ
                                   \n`);

  // Check for updates if needed
  if (!updatesChecked) {
    spinnies.add('venom-version-spinner', {
      text: 'ğŸ•·ğŸ•·ğŸ•·Checking for updatesğŸ•·ğŸ•·ğŸ•·',
    });
    checkVenomVersion(spinnies);
    updatesChecked = true;
  }

  // Initialize whatsapp
  spinnies.add(`${session}-auth`, {
    text: 'ğŸ•·ğŸ•·ğŸ•·Waiting...ğŸ•·ğŸ•·ğŸ•·',
  });

  const mergedOptions = { ...defaultOptions, ...options };
  let waPage = await initWhatsapp(session, mergedOptions);

  spinnies.update(`${session}-auth`, { text: 'ğŸ•·ğŸ•·ğŸ•·Authenticating...ğŸ•·ğŸ•·ğŸ•·' });
  const authenticated = await isAuthenticated(waPage);

  // If not authenticated, show QR and wait for scan
  if (authenticated) {
    // Wait til inside chat
    if (statusFind) {
      statusFind('isLogged');
    }

    await isInsideChat(waPage).toPromise();
    spinnies.succeed(`${session}-auth`, { text: 'ğŸ•·ğŸ•·ğŸ•·AuthenticatedğŸ•·ğŸ•·ğŸ•·' });
  } else {
    if (statusFind) {
      statusFind('notLogged');
    }
    spinnies.update(`${session}-auth`, {
      text: `Authenticate to continue`,
    });

    if (mergedOptions.refreshQR <= 0) {
      const { data, asciiQR } = await retrieveQR(waPage);
      if (catchQR) {
        catchQR(data, asciiQR);
      }

      if (mergedOptions.logQR) {
        console.log(`Scan QR for: ${session}                `);
        console.log(asciiQR);
      }
    } else {
      grabQRUntilInside(waPage, mergedOptions, session, catchQR);
    }

    // Wait til inside chat
    await isInsideChat(waPage).toPromise();
    spinnies.succeed(`${session}-auth`, { text: 'ğŸ•·ğŸ•·ğŸ•·Compilation MutationğŸ•·ğŸ•·ğŸ•·' });
  }
  spinnies.add(`${session}-inject`, { text: 'ğŸ•·ğŸ•·ğŸ•·Injecting Sibionte...ğŸ•·ğŸ•·ğŸ•·' });
  waPage = await injectApi(waPage);
  spinnies.succeed(`${session}-inject`, { text: 'Starting With Success!' });

  // Saving Token
  spinnies.add(`${session}-inject`, { text: 'ğŸ•·ğŸ•·ğŸ•· Saving Token...  ğŸ•·ğŸ•·ğŸ•·' });
  if (true) {
    const localStorage = JSON.parse(
      await waPage.evaluate(() => {
        return JSON.stringify(window.localStorage);
      })
    );

    let { WABrowserId, WASecretBundle, WAToken1, WAToken2 } = localStorage;

    try {
      setTimeout(() => {
        mkdir(
          path.join(path.resolve(process.cwd(), 'tokens')),
          { recursive: true },
          (err) => {
            if (err) {
              spinnies.fail(`${session}-inject`, {
                text: 'ğŸ•·ğŸ•·ğŸ•· Failed to create folder tokens...  ğŸ•·ğŸ•·ğŸ•·',
              });
            }
          }
        );
      }, 200);

      setTimeout(() => {
        writeFileSync(
          path.join(
            path.resolve(process.cwd(), 'tokens'),
            `${session}.data.json`
          ),
          JSON.stringify({ WABrowserId, WASecretBundle, WAToken1, WAToken2 })
        );
        spinnies.succeed(`${session}-inject`, {
          text: 'ğŸ•·ğŸ•·ğŸ•· Token saved successfully...  ğŸ•·ğŸ•·ğŸ•·',
        });
      }, 500);
    } catch (error) {
      spinnies.fail(`${session}-inject`, {
        text: 'ğŸ•·ğŸ•·ğŸ•· Failed to save token...  ğŸ•·ğŸ•·ğŸ•·',
      });
    }
  }

  if (mergedOptions.debug) {
    const debugURL = `http://localhost:${readFileSync(
      `./${session}/DevToolsActivePort`
    ).slice(0, -54)}`;
    console.log(`\nDebug: \x1b[34m${debugURL}\x1b[0m`);
  }

  return new Whatsapp(waPage);
}

function grabQRUntilInside(
  waPage: Page,
  options: CreateConfig,
  session: string,
  catchQR: (qrCode: string, asciiQR: string) => void
) {
  const isInside = isInsideChat(waPage);
  timer(0, options.refreshQR)
    .pipe(
      takeUntil(isInside),
      switchMap(() => retrieveQR(waPage))
    )
    .subscribe(({ data, asciiQR }) => {
      if (catchQR) {
        catchQR(data, asciiQR);
      }
      if (options.logQR) {
        console.clear();
        console.log(`Scan QR for: ${session}                `);
        console.log(asciiQR);
      }
    });
}

/**
 * Checs for a new versoin of venom and logs
 */
function checkVenomVersion(spinnies) {
  latestVersion('venom-bot').then((latest) => {
    if (!upToDate(version, latest)) {
      logUpdateAvailable(version, latest);
    }

    spinnies.succeed('venom-version-spinner', { text: 'Checking for updates' });
  });
}

/**
 * Logs a boxen of instructions to update
 * @param current
 * @param latest
 */
function logUpdateAvailable(current: string, latest: string) {
  // prettier-ignore
  const newVersionLog =
  `There is a new version of ${chalk.bold(`Venom`)} ${chalk.gray(current)} âœ  ${chalk.bold.green(latest)}\n` +
  `Update your package by running:\n\n` +
  `${chalk.bold('\>')} ${chalk.blueBright('npm update venom-bot')}`;

  console.log(boxen(newVersionLog, { padding: 1 }));
  console.log(
    `For more info visit: ${chalk.underline(
      'https://github.com/orkestral/venom/blob/master/UPDATES.md'
    )}\n`
  );
}
