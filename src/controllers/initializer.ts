/*
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mMMMMMMMMMNNNmmNNNMMNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNMMNMMMMNNNNNmmmddhdddNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mddNMMNy:/odNmmddmmNNmdhhddmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmmdNMNd:--+dNmmddhhddmmhsyhhmdmmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNmdNmy:.-oyNmmmhmdhho+sososyhhhddNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmmNdh+-`.:oyNNdmmdmmdo-://oysssyhhhdmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
Nmmmoyyyo+osdNmdmmddNNhs+/::/+osyssydyhdNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NNmhsymMMNmmmmdmdNNddNmsso+++////ossssyyhdmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mhhhmNNMNNNhssshhmmddmmssyooooso/::+oysshhhhmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmdhdddNNdyoosyhdmddmmmsoooooyysyys/::/oyyhhhyMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mdddhddmhsooshdmdmdhhyyyysso/ooo+syhhs/-/+shyhMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
dyyhdmd+ososhdmdmyyhhhhhhhyo++o/+///+ohhso++sdMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
dhdmNNdsossyhmdmsydhssssyhhs/++o/o+//:++yhhy+/hNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mdmNNNNmhysshddyshdyyy/oss+s::/:://++///++++/::hmNNNNNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NNMNNNmmNNdymNNhshdshdyhdysh+sy+-:++osssosss++yNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNNNmdNNmNmmmNmyyddyyhdhydyohys/-oo+osssysyyohNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNNNhdNmmNNmNMMNhyyhhhdhyyhmmyh+-/s+sysssyyhyydNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mNMMMhdNdmMNMMMMMNNmdhdddmhdmmNho/-osoyyo++oyddhhNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NMMMNmhNdNMNMNMMNmNNNmmmdyoohmhoyo::hsooo++oooydhymMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMNNNhmNNMmmNMNNmmmmdmmdyhhoyddddoo++yoyysooossyhsmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMNNNmmNNNmdNdNmmddhhhdNNhsmNssdooo/dso++osyyysoymMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMNNNNmNNNNNmddmmNhshNmmmNmNMdhNsh/ohho++/:++MMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MNNNMMNNNNmmmhhhhdyosdNmdmMMhoNmhdmys+ooo++/+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNNNMMNNNNmddmdoodmMMNmmNNhssdmNMMMNdNd/osomMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNdhMNmNNMNmdNddohmMMNNNmdmdddNMMMMMMMMmMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNhmMmmmmNNmdNyoNMNmNmdhyyyhdhoyNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmdmMmmddddNmmdys+hmMMMmmhysssyy++dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmdNMMdmdddmmNNyshmNNNNNNNdhhs+yy//dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNMMMdmdddmmMNysdmNNMMMNhhNdhs+y+/:mMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNMMNhmmddNNNMdyydmMMMNdyshNhyoss+:/MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmNMMddmmmmNMNMNdsymNNmdhhdNMNdhsss+:yMMMMMMMMMMMMMMMMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMdhmmmmmNMNNMmshNMMMmmMMMMMmNdyo+//NMMMMMMMMMMMMMMMhNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMmhmmmmmmNMMNNMyshdhhhyhNMMMMMMdhso+sMMMMMMMMMMMMMMMhmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMmdmmmmmmmNMMMmNm+ys++oyyNMMMMMMNmmyyoyNMMMMMMMMMMMMMddMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NmmmmmmmmmmmNMNNmNNyyo+/oohNMMMMMMMMdhhsshmMMMMMMMMMMMyNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
mmNNNNNNmmmmNMMNmmddNmmdhhdmMMMMMMMMMNddhssshmmNNNmmdhdMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
NNNNNNNNNNNNNNNNmNNNNMMMMMNomMMMMMMMMMNNmdhhyyyyyyyhdmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
Nd+oNMMMMMMMmodo++++++++++m..yNMMMMMNo+mNMMmhssshdNMMNhNMMMMMMMMMMMddMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MN+ /NMMMMMm: d` -ssssss+`d. `+mMMMMN. dNm+:+syso//hNN--yNMMMMMMMd+`yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMN+ /NMMMm: oM` +NMMMMMNdN. /`.yNMMN. dh.omMMMMMNy.oM- `:hNMMMm+.  yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMN/ /NMm: oNy` :sssmMMMMN. dh-`/mMN. d-/NMMMMMMMMy`m- y/`/dmo..o: yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMN/ /m: +NNy. /yyyNMMMMN. dNNo`.yN- d.oNMMMMMMMMd d- mNh-`.`+mN/ yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMN/ . +NMMN- oNMMMMMNdN. dMMMd:`/. ds.dNMMMMMMm::M- dMMNy/dMMN/ yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMN/ +NMMMN- /yyyyyys d. dMMMMNo`  dNy-+ymmmho-+NN- dMMMMMMMMN/ yMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMNyNMMMMN+::::::::::m+/mMMMMMMd: dMMNho///+ymMMN+/mMMMMMMMMNs/hMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMNMMMMMMMMMMMMMMMMMMMMMMMMMMMMNsmMMMMMMMMMMMMMMNNNNMMNNNMMNNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNMMMMMMMMMMMMMMNMMNMNMMMNMMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNMMNMNMMMNMMNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNNNNMMNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
*/

import { readFileSync, writeFileSync, mkdir } from 'fs';
import latestVersion from 'latest-version';
import { Whatsapp } from '../api/whatsapp';
import { CreateConfig, defaultOptions } from '../config/create-config';
import { upToDate } from '../utils/semver';
import { isAuthenticated, isInsideChat, asciiQr, retrieveQR } from './auth';
import { initWhatsapp, injectApi, initBrowser } from './browser';
import chalk = require('chalk');
import boxen = require('boxen');
import Spinnies = require('spinnies');
import path = require('path');
import Counter = require('../lib/counter/Counter.js');
const { version } = require('../../package.json');
import { scrapeImgReload, scrapeImg } from '../api/helpers';

// Global
let updatesChecked = false;
let browserFail = false;
var browser_fail: any, browser_check: any, closeBrowser: any;
const counter = new Counter();
/**
 * consult status of whatsapp client
 */

/**
 * Should be called to initialize whatsapp client
 */
export async function create(
  session = 'session',
  catchQR?: (qrCode: string, asciiQR: string) => void,
  statusFind?: (statusGet: string) => void,
  options?: CreateConfig
) {
  const spinnies = new Spinnies({
    disableSpins: options ? options.disableSpins : '',
  });

  const mergedOptions = { ...defaultOptions, ...options };

  console.log(`\n
▗▄ ▄ ▄  ▄▄▄ ▄   ▄▄▄  ▗▄▄▖▗▄▖ ▗▄▖▄▄▄▖                           
 █▟█▙█  █▄▄ █   █    █ ▐█ █ █ █ █▄▄                           
 ▐█ █▌  █▄▄ ███ ▜▄▛▘ ▜▙▟▀ █   █ █▄▄▖                           
                                                      
▄▄▄▖       ▄▄▄▄▄▄▄▄▄▄▄▟▌▀▖     ▗▄▄▖                        
▝▄ ▐▖     ▟▘▐         ▐▌ ▝▙    ▐  ▌ ▄▞▀▀▀▀▀▄▖ ▛▀▄        ▄▘▌
 ▝▄ ▐▖   ▐▘ ▟▖ ▜▀▀▀▀▀▌▐▖  ▝▚▖  ▐  ▙▞▘▗▞▀▀▀▚▖▝▙▛ ▝▜▖    ▗▀  ▌
  ▀▖ ▜  ▗▘ ▟█  ▜     ▝▐▌ ▟▖ ▜▖ ▐  █ ▟▘     ▐▖▝█   ▝▙▖▗▞▘   ▌
   ▜▖ ▜▄▛ ▐▜▝  ▝ ▘▜   ▝▌ ▟▀▖ ▝▙▐  ▌▗▌       ▜ ▙ ▐▙▖ ▀▘ ▗▟▘ ▌
    ▚▖ ▀ ▗▌▝▜▖ ▜▀▀▀   ▐▌ ▟ ▝▙  ▜  ▙ ▙       ▛ ▙ ▐▌▝▄  ▟▀▐▘ ▌
     ▚▖ ▗▛  ▐▖ ▜    ▗▛▜▌ ▟   ▚▖   █▖▝▙▖   ▗▛ ▟▛ ▐▖  ▀▞  ▐▖ ▌
     ▝▚▗▛   ▐   ▘▘▘▘▘ ▐▌ ▟    ▀▄  ▌▝▙▖▝▀▀▀▘▗▞▘▛ ▐▌      ▐  ▌
      ▝▛    ▝▀▝▘▘▘▘▘▘▀▝▘▘▀     ▝▙ ▌  ▝▀▘▘▀▀▘  ▀▘▀       ▝▀▝▘
                                 ▚▌
                                   \n`);

  // Check for updates if needed
  if (!updatesChecked && mergedOptions.updatesLog) {
    spinnies.add('venom-version-spinner', {
      text: 'Checking for updates',
    });
    checkVenomVersion(spinnies);
    updatesChecked = true;
  }

  // Initialize whatsapp
  spinnies.add(`${session}-auth`, {
    text: 'Waiting...',
  });

  const browser = await initBrowser(session, mergedOptions);

  if (browser != null) {
    spinnies.add(`browser`, {
      text: 'check headless',
    });

    if (mergedOptions.headless) {
      spinnies.succeed(`browser`, {
        text: 'headless option is active, browser hidden',
      });
    } else {
      spinnies.succeed(`browser`, {
        text: 'headless option is disabled, browser visible',
      });
    }

    browser['_process'].once('close', () => {
      browser['isClose'] = true;
    });

    browser_fail = setInterval(() => {
      if (browser['isClose'] != undefined) {
        spinnies.fail(`${session}-auth`, {
          text: 'The browser is closed',
        });
        browserFail = true;
        if (statusFind) {
          statusFind('browserClose');
        }
        clearInterval(browser_fail);
      }
    }, 1000);

    var waPage = await initWhatsapp(session, mergedOptions, browser);

    if (waPage) {
      spinnies.update(`${session}-auth`, { text: 'Authenticating...' });

      let authenticated = null;

      await isAuthenticated(waPage)
        .then((e) => {
          authenticated = e;
        })
        .catch(() => {});

      if (authenticated != null) {
        // If not authenticated, show QR and wait for scan
        if (authenticated) {
          // Wait til inside chat
          if (statusFind) {
            statusFind('isLogged');
          }

          await isInsideChat(waPage).toPromise();
          spinnies.succeed(`${session}-auth`, { text: 'Authenticated' });
        } else {
          if (statusFind) {
            statusFind('notLogged');
          }
          spinnies.add(`autoclose`, { text: 'check autoClose' });
          if (mergedOptions.autoClose > 0) {
            spinnies.succeed(`autoclose`, {
              text: 'the autoClose function is on',
            });

            closeBrowser = setTimeout(() => {
              browserFail = true;
              browser.close();
              clearInterval(browser_check);
            }, mergedOptions.autoClose);
          } else {
            spinnies.succeed(`autoclose`, {
              text: 'the autoClose function is off ',
            });
          }

          let tipo_qr = 0,
            result = undefined,
            url = null;

          browser_check = setInterval(async () => {
            if (browser['isClose'] != undefined) {
              if (statusFind) {
                statusFind('qrReadFail');
              }
              browserFail = true;
              clearInterval(browser_check);
            } else {
              switch (tipo_qr) {
                case 0:
                  result = await scrapeImg(waPage).catch(() => {});
                  if (result != undefined) {
                    var { data, asciiQR } = await retrieveQR(waPage);
                    if (catchQR) {
                      catchQR(data, asciiQR);
                    }
                    await asciiQr(result['url'])
                      .then((qr) => {
                        if (mergedOptions.logQR) {
                          spinnies.update(`${session}-auth`, {
                            text: 'Scan QR for Session: ' + session,
                          });
                          console.log(qr);
                        }
                        tipo_qr++;
                      })
                      .catch(() => {});
                  }
                  break;
                case 1:
                  result = await scrapeImgReload(waPage, url).catch(() => {});
                  if (typeof result === 'object') {
                    url = result.url;
                  }
                  if (typeof result === 'object' && result.status === true) {
                    let re = await scrapeImg(waPage).catch(() => {});
                    if (re != undefined) {
                      var { data, asciiQR } = await retrieveQR(waPage);
                      if (catchQR) {
                        catchQR(data, asciiQR);
                      }
                      await asciiQr(re['url'])
                        .then((qr) => {
                          if (mergedOptions.logQR) {
                            spinnies.update(`${session}-auth`, {
                              text: 'Scan QR for Session: ' + session,
                            });
                            console.log(qr);
                          }
                        })
                        .catch(() => {});
                    }
                  }
                  break;
              }
            }
          }, 1000);

          if (!browserFail) {
            // Wait til inside chat
            var IsLog = await isInsideChat(waPage).toPromise();
            if (IsLog == false) {
              return false;
            }
            if (statusFind) {
              statusFind('qrReadSuccess');
            }
            spinnies.succeed(`${session}-auth`, {
              text: 'Compilation Mutation',
            });
          }
        }
        if (!browserFail) {
          spinnies.add(`${session}-inject`, { text: 'Injecting Sibionte...' });
          waPage = await injectApi(waPage);
          clearInterval(browser_fail);
          clearInterval(browser_check);
          clearTimeout(closeBrowser);

          spinnies.succeed(`${session}-inject`, {
            text: 'Starting With Success!',
          });

          // Saving Token
          spinnies.add(`${session}-inject`, { text: 'Saving Token...' });

          if (true) {
            const localStorage = JSON.parse(
              await waPage.evaluate(() => {
                return JSON.stringify(window.localStorage);
              })
            );

            let {
              WABrowserId,
              WASecretBundle,
              WAToken1,
              WAToken2,
            } = localStorage;

            try {
              setTimeout(() => {
                mkdir(
                  path.join(path.resolve(process.cwd(), 'tokens')),
                  { recursive: true },
                  (err) => {
                    if (err) {
                      spinnies.fail(`${session}-inject`, {
                        text: 'Failed to create folder tokens...',
                      });
                    }
                  }
                );
              }, 200);

              setTimeout(() => {
                writeFileSync(
                  path.join(
                    path.resolve(process.cwd(), 'tokens'),
                    `${session}.data.json`
                  ),
                  JSON.stringify({
                    WABrowserId,
                    WASecretBundle,
                    WAToken1,
                    WAToken2,
                  })
                );
                spinnies.succeed(`${session}-inject`, {
                  text: 'Token saved successfully...',
                });
              }, 500);
            } catch (error) {
              spinnies.fail(`${session}-inject`, {
                text: 'Failed to save token...',
              });
            }
          }

          if (mergedOptions.debug) {
            const debugURL = `http://localhost:${readFileSync(
              `./${session}/DevToolsActivePort`
            ).slice(0, -54)}`;
            console.log(`\nDebug: \x1b[34m${debugURL}\x1b[0m`);
          }

          return new Whatsapp(waPage);
        }
      }
    }
  }
}

/**
 * Checs for a new versoin of venom and logs
 */
function checkVenomVersion(spinnies) {
  latestVersion('venom-bot').then((latest) => {
    if (!upToDate(version, latest)) {
      logUpdateAvailable(version, latest);
    }

    spinnies.succeed('venom-version-spinner', { text: 'Checking for updates' });
  });
}

/**
 * Logs a boxen of instructions to update
 * @param current
 * @param latest
 */
function logUpdateAvailable(current: string, latest: string) {
  // prettier-ignore
  const newVersionLog =
    `There is a new version of ${chalk.bold(`Venom`)} ${chalk.gray(current)} ➜  ${chalk.bold.green(latest)}\n` +
    `Update your package by running:\n\n` +
    `${chalk.bold('\>')} ${chalk.blueBright('npm update venom-bot')}`;

  console.log(boxen(newVersionLog, { padding: 1 }));
  console.log(
    `For more info visit: ${chalk.underline(
      'https://github.com/orkestral/venom/blob/master/UPDATES.md'
    )}\n`
  );
}
